name: Lint YAML
on: [pull_request]

jobs:
  get:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.get-files.outputs.result }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      - name: Get source files
        uses: actions/github-script@v6
        id: get-files
        with:
          script: |
            const fs = require('fs');
            const Path = require('path');
            const workspace = process.env.GITHUB_WORKSPACE;

            let files = fs.readdirSync(Path.join(workspace, 'src'));
            files = files.map((file) => Path.join('./src', file));
            let connectors = fs.readdirSync(Path.join(workspace, 'src/connectors'));
            connectors = connectors.map((file) => Path.join('./src/connectors', file));
            files.concat(connectors);
            return files.filter((filename) => filename.endsWith('yaml'));

  lint:
    runs-on: ubuntu-latest
    needs: get
    if: ${{ always() }}
    strategy:
      fail-fast: false
      matrix:
        sample: ${{ fromJSON(needs.get.outputs.matrix) }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.8

      - name: Install yamllint
        run: |-
          pip3 install --user wheel 
          pip3 install --user yamllint==1.26.3

      - name: Lint YAML files
        run: yamllint -f github -c $GITHUB_WORKSPACE/tests/.yamllint ${{ matrix.sample }}
